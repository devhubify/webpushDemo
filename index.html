<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPush Demo - Inscri√ß√£o e Disparo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        'byd-primary': '#1e40af', // Cor prim√°ria simulada (azul escuro)
                        'byd-accent': '#3b82f6', // Cor de destaque (azul claro)
                    }
                }
            }
        }
    </script>
    <style>
        #log { max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        <header class="text-center py-6 mb-8 border-b border-byd-primary">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-byd-primary">Ferramenta de Demo WebPush</h1>
            <p class="mt-2 text-gray-600">Teste o ciclo de vida da Inscri√ß√£o, Disparo e Remo√ß√£o de Notifica√ß√µes.</p>
        </header>
        <main class="space-y-8">
            <section class="card bg-white p-6 rounded-xl">
                <h2 class="text-2xl font-semibold text-byd-accent mb-4">1. Status e Controle</h2>
                <div id="status-container" class="mb-4 p-3 bg-gray-100 rounded-lg">
                    <p class="font-medium">Permiss√£o Atual: <span id="notification-status" class="font-bold text-gray-700">Verificando...</span></p>
                    <p class="font-medium">Service Worker: <span id="sw-status" class="font-bold text-gray-700">Aguardando...</span></p>
                </div>
                <p class="text-sm text-gray-500 mb-4">Use os bot√µes abaixo para gerenciar sua inscri√ß√£o nas notifica√ß√µes push.</p>
                
                <button id="subscribe-button" class="w-full sm:w-auto px-6 py-3 bg-byd-primary text-white font-bold rounded-lg hover:bg-byd-accent transition duration-150 disabled:opacity-50">
                    Ativar Notifica√ß√µes (Opt-In)
                </button>

                <button id="unsubscribe-button" class="w-full sm:w-auto px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-150" style="display: none;">
                    Desativar Notifica√ß√µes
                </button>
            </section>
            <section class="card bg-white p-6 rounded-xl">
                <h2 class="text-2xl font-semibold text-byd-accent mb-4">2. Dados da Inscri√ß√£o (Token)</h2>
                <p class="mb-4 text-sm text-gray-600">Este JSON √© o **PushSubscription Object** que seu Front-End envia para o Backend.</p>
                <div class="bg-gray-800 text-green-300 p-4 rounded-lg overflow-x-auto text-sm">
                    <pre id="subscription-data" class="text-xs sm:text-sm">Aguardando inscri√ß√£o...</pre>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700">VAPID Public Key (Usada no Frontend):</label>
                    <input type="text" id="vapid-key-display" readonly class="mt-1 block w-full border border-gray-300 p-2 rounded-lg bg-gray-100 text-gray-700 text-xs" value="BMCTCx-A6eyruSecRiGXsEi7ek9CVXSpI22gXI_3hy-cnhEGHOOUOuhxnVpxMq3nH2LEdBgACQaLrsL6Lv7ibdI">
                </div>
            </section>
            <section class="card bg-white p-6 rounded-xl">
                <h2 class="text-2xl font-semibold text-byd-accent mb-4">3. Disparo de Teste (Via Backend)</h2>
                <p class="mb-4 text-sm text-gray-600">Este formul√°rio envia os dados para sua API na Vercel, que dispara a notifica√ß√£o para todos os inscritos.</p>
                <form id="push-form" class="space-y-4">
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">T√≠tulo da Notifica√ß√£o:</label>
                        <input type="text" id="title" class="mt-1 block w-full border border-gray-300 p-3 rounded-lg focus:ring-byd-accent focus:border-byd-accent" value="Notifica√ß√£o de Teste" required>
                    </div>
                    <div>
                        <label for="body" class="block text-sm font-medium text-gray-700">Corpo da Mensagem:</label>
                        <textarea id="body" class="mt-1 block w-full border border-gray-300 p-3 rounded-lg focus:ring-byd-accent focus:border-byd-accent" rows="2" required>üéâ A notifica√ß√£o da demo est√° funcionando!</textarea>
                    </div>
                    <div>
                        <label for="url" class="block text-sm font-medium text-gray-700">URL ao Clicar:</label>
                        <input type="url" id="url" class="mt-1 block w-full border border-gray-300 p-3 rounded-lg focus:ring-byd-accent focus:border-byd-accent" value="https://vercel.com" required>
                    </div>
                    <button type="submit" id="send-push-button" class="w-full px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150" disabled>
                        Disparar Notifica√ß√£o (Para Todos)
                    </button>
                </form>
            </section>
            <section class="card bg-gray-900 p-6 rounded-xl">
                <h2 class="text-2xl font-semibold text-white mb-4">4. Log de Atividades (Console)</h2>
                <div id="log" class="bg-black p-3 rounded-lg text-gray-300 text-xs">
                    Iniciando a aplica√ß√£o...
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        function logMessage(message, type = 'info') {
            const logElement = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            let color = 'text-gray-300';
            if (type === 'error') color = 'text-red-400';
            if (type === 'success') color = 'text-green-400';
            if (type === 'warning') color = 'text-yellow-400';
            logElement.innerHTML += `<div class="${color}">[${now}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
            return outputArray;
        }

        // --- VARI√ÅVEIS GLOBAIS ---
        const VAPID_PUBLIC_KEY = document.getElementById('vapid-key-display').value;
        const subscribeButton = document.getElementById('subscribe-button');
        const unsubscribeButton = document.getElementById('unsubscribe-button');
        const sendPushButton = document.getElementById('send-push-button');
        let currentSubscription = null;
        let serviceWorkerRegistration = null;

        // --- FUN√á√ïES PRINCIPAIS ---

        async function subscribeUser() {
            try {
                const permission = await Notification.requestPermission();
                document.getElementById('notification-status').textContent = permission.toUpperCase();
                if (permission !== 'granted') throw new Error('Permiss√£o de notifica√ß√£o negada.');

                logMessage('Inscrevendo para notifica√ß√µes push...', 'info');
                const subscription = await serviceWorkerRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                logMessage('Enviando inscri√ß√£o para o servidor...', 'info');
                await fetch('/api/save-subscription', {
                    method: 'POST', body: JSON.stringify(subscription), headers: { 'Content-Type': 'application/json' },
                });
                
                logMessage('Inscri√ß√£o salva no servidor com sucesso!', 'success');
                currentSubscription = subscription;
                updateUI();
            } catch (error) {
                logMessage(`Falha na Inscri√ß√£o: ${error.message}`, 'error');
                updateUI();
            }
        }

        async function unsubscribeUser() {
            if (!currentSubscription) return;

            logMessage('Desativando inscri√ß√£o...', 'warning');
            try {
                await fetch('/api/delete-subscription', {
                    method: 'POST', body: JSON.stringify(currentSubscription), headers: { 'Content-Type': 'application/json' },
                });
                logMessage('Inscri√ß√£o removida do servidor.', 'success');

                await currentSubscription.unsubscribe();
                
                currentSubscription = null;
                updateUI();
                logMessage('Notifica√ß√µes desativadas com sucesso!', 'success');
            } catch (error) {
                logMessage(`Erro ao desativar: ${error.message}`, 'error');
            }
        }

        function updateUI() {
            if (currentSubscription) {
                subscribeButton.style.display = 'none';
                unsubscribeButton.style.display = 'inline-block';
                sendPushButton.disabled = false;
                document.getElementById('subscription-data').textContent = JSON.stringify(currentSubscription, null, 2);
            } else {
                subscribeButton.style.display = 'inline-block';
                unsubscribeButton.style.display = 'none';
                sendPushButton.disabled = true;
                document.getElementById('subscription-data').textContent = 'Nenhuma inscri√ß√£o ativa.';
                subscribeButton.disabled = Notification.permission === 'denied';
            }
        }
        
        // --- L√ìGICA DE INICIALIZA√á√ÉO E EVENTOS ---

        subscribeButton.addEventListener('click', subscribeUser);
        unsubscribeButton.addEventListener('click', unsubscribeUser);

        document.getElementById('push-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const payload = {
                title: document.getElementById('title').value,
                body: document.getElementById('body').value,
                url: document.getElementById('url').value,
            };
            logMessage('Enviando pedido de notifica√ß√£o para o servidor...', 'warning');
            try {
                const response = await fetch('/api/send-notification', {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(`Falha no servidor: ${response.statusText}`);
                logMessage('Servidor aceitou o pedido. Notifica√ß√£o deve chegar em breve!', 'success');
            } catch (error) {
                logMessage(`Erro ao enviar notifica√ß√£o: ${error.message}`, 'error');
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            logMessage('DOM carregado. Verificando suporte...');
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    logMessage('Service Worker registrado.', 'success');
                    document.getElementById('sw-status').textContent = 'REGISTRADO';

                    document.getElementById('notification-status').textContent = Notification.permission.toUpperCase();
                    
                    currentSubscription = await serviceWorkerRegistration.pushManager.getSubscription();
                    updateUI();

                } catch (error) {
                    logMessage(`Falha no registro do SW: ${error}`, 'error');
                    document.getElementById('sw-status').textContent = 'FALHA';
                }
            } else {
                logMessage('Seu navegador n√£o suporta Service Workers ou WebPush.', 'error');
                subscribeButton.disabled = true;
            }
        });
    </script>
</body>
</html>